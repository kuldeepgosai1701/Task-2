<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>History Sessions</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:20px; }
    h2 { text-align:center; margin-bottom:20px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#004080; color:#fff; }
    #map { height:400px; margin-top:20px; border-radius:10px; }
  </style>
</head>
<body>

<h2>ðŸ“Œ Motion History</h2>
<table>
  <thead>
    <tr>
      <th>Start Time</th>
      <th>Stop Time</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="sessionTable"></tbody>
</table>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

// Clear all previous sessions on page load
localStorage.removeItem("sessions");

  // Initialize map
  let map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let pathLine = L.polyline([], { color: 'blue' }).addTo(map);
  let dotMarker = L.circleMarker([0, 0], { radius: 6, fillColor: 'red', color: 'darkred', weight: 1 }).addTo(map);

  // Load all sessions from localStorage
  const sessions = JSON.parse(localStorage.getItem("sessions")) || [];

  const tbody = document.getElementById("sessionTable");
  tbody.innerHTML = "";

  // Populate table with sessions
 
[...sessions].reverse().forEach((session, index) => {
    const startTime = new Date(session.start);
    const stopTime = session.end ? new Date(session.end) : null;

    let row = document.createElement("tr");
    row.innerHTML = `
      <td>${startTime.toLocaleString()}</td>
      <td>${stopTime ? stopTime.toLocaleString() : "Ongoing"}</td>

      <td><button onclick="openSession(${index})">Open</button></td>
    `;
    tbody.appendChild(row);
  });

  // Function to show path for a selected session
  function openSession(index) {
    const session = sessions[index];
    if (!session || session.data.length === 0) {
      alert("No data available for this session.");
      return;
    }

    const coords = session.data.map(p => [p.lat, p.lon]);
    pathLine.setLatLngs(coords);
    dotMarker.setLatLng(coords[coords.length - 1]);
    map.fitBounds(coords);
  }
</script>
</body>
</html>
