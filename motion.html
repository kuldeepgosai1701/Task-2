<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPS Motion Tracker with Leaflet</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
     body, html {
     height: 100%;
     font-family: "Inter", sans-serif;
     display: flex;
     flex-direction: column;
     background: #f7f9fc;
    }

    header {
  display: none;
}

.info {
  position: fixed;
  top: 20px;
  left: 20px;
  background: #fff;
  padding: 14px 16px;
  border-radius: 16px;
  z-index: 1001;
  width: 260px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  font-size: 14px;
  line-height: 1.4;
}
.info p:first-child {
  font-weight: 600;
  margin-bottom: 6px;
  font-size: 15px;
}


/* ‚úÖ Buttons Group */
.button-group {
  margin-top: 10px;
  display: flex;
  gap: 8px;
}

.button-group button {
  flex: 1;
  padding: 8px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  color: white;
  transition: 0.2s;
  font-size: 14px;
}

.button-group .start {
  background: linear-gradient(135deg, #2a9df4, #00b300);
}
.button-group .stop {
  background: linear-gradient(135deg, #444, #b31515);
}
.button-group .reset {
  background: linear-gradient(135deg, #6c757d, #000000);
}
.button-group button:hover {
  opacity: 0.9;
}
    .sensitivity-box {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(135deg, #2a3b8f, #001f54);
  color: #fff;
  padding: 14px 18px;
  border-radius: 16px;
  z-index: 1001;
  width: 200px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
  font-size: 14px;
}

.sensitivity-box h3 {
  margin-bottom: 6px;
  font-size: 15px;
  font-weight: 600;
}

.sensitivity-box input[type="range"] {
  width: 100%;
  margin: 8px 0;
}
  #map {
  flex: 1;
  width: 100%;
}

    /*footer {
      background: linear-gradient(90deg, #004080, #0066cc);
       color: white;
  text-align: center;
  padding: 14px;
  font-size: 1rem;
    }*/
  </style>
</head>

<body>
<header>

<button onclick="openHistoryPage()" style="float: right; margin-right: 10px;">History</button>
</header>

<div class="sensitivity-box">
  <h3>Sensitivity</h3>
  <input type="range" id="sensitivityRange" min="0" max="10" step="1" value="5">
  <div>Value: <span id="sensVal">5</span></div>
</div>

<div class="info">
  <p>üìç Tracker Info</p>
  <p id="location">Location: Fetching...</p>
  <p id="direction">Direction: Calculating...</p>

  <div class="button-group">
  <button class="start" onclick="startTracking()">‚ñ∂ Start</button>
  <button class="stop">‚è∏ Stop</button>
  <button class="reset">‚ü≥ Reset</button>
 </div> 
</div>

<!-- Map container -->
<div id="map"></div>

<!-- History Modal -->
<div id="historyModal" 
     style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            background:#fff; padding:20px; border-radius:12px; box-shadow:0px 4px 15px rgba(0,0,0,0.3);
            z-index:2000; width:300px; max-height:400px; overflow:auto;">
  <h3>üìå History</h3>
  <ul id="historyList" style="list-style:none; padding-left:0;"></ul>
  <button onclick="closeHistory()" 
          style="margin-top:10px; background:#d9534f; color:#fff; border:none; padding:6px 12px; border-radius:6px;">Close</button>
</div>

<footer>
<p>Created by Kuldeep Gosai</p>
</footer>
</body>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

  window.onload = function() {
  localStorage.removeItem("gpsHistory");
  localStorage.removeItem("recordedData");
  localStorage.removeItem("sessions");
};

  let prevLat = null, prevLon = null;
  let gpsHistory = [];
  let sessionStartTime = null;
  let recordedData = [];
  let sensitivityFactor = 5;
  let vibratedRecently = false;
  let trackingInterval = null;

  const locationText = document.getElementById("location");
  const directionText = document.getElementById("direction");
  const sensitivityRange = document.getElementById("sensitivityRange");
  const sensVal = document.getElementById("sensVal");

  sensitivityRange.addEventListener("input", () => {
    sensitivityFactor = parseFloat(sensitivityRange.value);
    sensVal.textContent = sensitivityRange.value;
  });

  // Leaflet map setup
  let map = L.map('map').setView([0, 0], 18);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let dotMarker = L.circleMarker([0, 0], {
    radius: 10,
    fillColor: "#007bff",
    color: "#003366",
    weight: 2,
    opacity: 1,
    fillOpacity: 0.9
  }).addTo(map);

  let pathCoords = [];
  let pathLine = L.polyline(pathCoords, { color: 'blue' }).addTo(map);

function showLocation(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const timestamp = new Date();  // current time

    // GPS history me store karo
    gpsHistory.push({lat, lon, time: timestamp});

   // ‚úÖ localStorage me bhi save karo
    localStorage.setItem("gpsHistory", JSON.stringify(gpsHistory));

    // UI update
    locationText.textContent = `Location: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    pathCoords.push([lat, lon]);
    pathLine.setLatLngs(pathCoords);
    dotMarker.setLatLng([lat, lon]);
    map.setView([lat, lon]);

    // Calculate direction based on previous position
    if (prevLat !== null && prevLon !== null) {
      const dx = lon - prevLon;
      const dy = lat - prevLat;
      const angle = Math.atan2(dy, dx) * (180 / Math.PI);
      directionText.textContent = `Direction: ${getDirectionFromAngle(angle)}`;
    }

    prevLat = lat;
    prevLon = lon;
}


  function getDirectionFromAngle(angle) {
    const directions = ["East ‚Üí", "North-East ‚ÜóÔ∏è", "North ‚Üë", "North-West ‚ÜñÔ∏è",
                        "West ‚Üê", "South-West ‚ÜôÔ∏è", "South ‚Üì", "South-East ‚ÜòÔ∏è"];
    return directions[Math.round((angle % 360 + 360) % 360 / 45) % 8];
  }

 function showError(error) {
  console.error("GPS Error:", error);
  switch(error.code) {
    case error.PERMISSION_DENIED:
      locationText.textContent = "Location: Permission denied";
      break;
    case error.POSITION_UNAVAILABLE:
      locationText.textContent = "Location: Position unavailable";
      break;
    case error.TIMEOUT:
      locationText.textContent = "Location: Timeout";
      break;
    default:
      locationText.textContent = "Location: Unknown error";
      break;
  }
}
function getDirectionFromAngle(angle) {
  // Normalize angle (-180 se 180 ko 0‚Äì360 me convert)
  angle = (angle + 360) % 360;

  if (angle >= 337.5 || angle < 22.5) return "East";
  if (angle >= 22.5 && angle < 67.5) return "North-East";
  if (angle >= 67.5 && angle < 112.5) return "North";
  if (angle >= 112.5 && angle < 157.5) return "North-West";
  if (angle >= 157.5 && angle < 202.5) return "West";
  if (angle >= 202.5 && angle < 247.5) return "South-West";
  if (angle >= 247.5 && angle < 292.5) return "South";
  if (angle >= 292.5 && angle < 337.5) return "South-East";
  
  return "Unknown";
}

function saveDataToFile() {

  const numberOfEntries = parseInt(sensitivityRange.value);

  // last N entries select 
  const recentData = recordedData.slice(-numberOfEntries);

  if (recentData.length === 0) {
    alert("No data to save.");
    return;
  }

let fileContent = "Alpha\tBeta\tGamma\tVibration\tDirection\n";
recentData.forEach(entry => {
  fileContent += `${entry.alpha.toFixed(2)}\t${entry.beta.toFixed(2)}\t${entry.gamma.toFixed(2)}\t${entry.vibration}\t${entry.direction}\n`;
});



  // download trigger 
  const blob = new Blob([fileContent], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `motion_data_last_${numberOfEntries}.txt`; 
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

  let watchId = null;

 function startTracking() {
  if ("geolocation" in navigator) {
    // ‚úÖ continuous GPS tracking
    trackingInterval = navigator.geolocation.watchPosition(
      showLocation,
      showError,
      {
        enableHighAccuracy: true,   // GPS chip use karega
        timeout: 10000,             // max wait 10 sec
        maximumAge: 0               // purana cache use na kare
      }
    );
  } else {
    alert("Geolocation not supported in this browser.");
  }
}
function startTracking() {
  if ("geolocation" in navigator) {
    // Check if sessions already exist
    let sessions = JSON.parse(localStorage.getItem("sessions")) || [];

    // Start a new session
    sessionStartTime = new Date();
    gpsHistory = []; // reset for new session
    localStorage.setItem("currentSession", JSON.stringify(gpsHistory));

    // Save to main sessions array with placeholder for end
    sessions.push({
      start: sessionStartTime.toISOString(),
      end: null,
      data: []
    });
    localStorage.setItem("sessions", JSON.stringify(sessions));

    watchId = navigator.geolocation.watchPosition(showLocation, showError, {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 5000
    });
  } else {
    alert("GPS not supported on this device/browser.");
  }
}

function stopTracking() {
  if (trackingInterval) {
    navigator.geolocation.clearWatch(trackingInterval);
    trackingInterval = null;
  }
}
function stopTracking() {
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;

    let sessions = JSON.parse(localStorage.getItem("sessions")) || [];
    let current = sessions[sessions.length - 1];
    if (current && !current.end) {
      current.end = new Date().toISOString();
      current.data = gpsHistory;
      localStorage.setItem("sessions", JSON.stringify(sessions));
    }
  }
}



function resetPage() {
  pathCoords = [];
  pathLine.setLatLngs(pathCoords);

  if (prevLat && prevLon) {
    dotMarker.setLatLng([prevLat, prevLon]);
    map.panTo([prevLat, prevLon], {animate: true, duration: 0.5});
  }
}


/*function toggleHistory() {
    const modal = document.getElementById("historyModal");
    const list = document.getElementById("historyList");
    list.innerHTML = "";

    if (modal.style.display === "none") {
        if (gpsHistory.length === 0) {
            alert("No history available yet.");
            return;
        }

       
        const startTime = gpsHistory[0].time;
        const endTime = gpsHistory[gpsHistory.length - 1].time;

        const li = document.createElement("li");
        li.style.cursor = "pointer";
        li.textContent = `${startTime.toLocaleDateString()} ${startTime.toLocaleTimeString()} ‚Äì ${endTime.toLocaleTimeString()}`;
        li.onclick = () => showHistoryPath(startTime, endTime);
        list.appendChild(li);

        modal.style.display = "block";
    } else {
        modal.style.display = "none";
    }
}*/

function toggleHistory() {
    const modal = document.getElementById("historyModal");
    const list = document.getElementById("historyList");
    list.innerHTML = "";

    if (modal.style.display === "none") {
        const sessions = JSON.parse(localStorage.getItem("sessions")) || [];

        if (sessions.length === 0) {
            alert("No history available yet.");
            return;
        }

        
        sessions.forEach((session, index) => {
            const startTime = new Date(session.start);
            const endTime = session.end ? new Date(session.end) : null;

            const li = document.createElement("li");
            li.style.cursor = "pointer";
            li.textContent = endTime
                ? `Session ${index + 1}: ${startTime.toLocaleString()} - ${endTime.toLocaleString()}`
                : `Session ${index + 1}: ${startTime.toLocaleString()} - Ongoing`;

            li.onclick = () => {
                const path = session.data.map(p => [p.lat, p.lon]);
                if (path.length > 0) {
                    pathLine.setLatLngs(path);
                    dotMarker.setLatLng(path[path.length - 1]);
                    map.fitBounds(path);
                } else {
                    alert("No data in this session.");
                }
                closeHistory();
            };

            list.appendChild(li);
        });

        modal.style.display = "block";
    } else {
        modal.style.display = "none";
    }
}

function closeHistory() {
    document.getElementById("historyModal").style.display = "none";
}

function showHistoryPath(startTime, endTime) {
    // filter gpsHistory for selected time range
    const filteredPath = gpsHistory.filter(p => p.time >= startTime && p.time <= endTime)
                                   .map(p => [p.lat, p.lon]);

    if (filteredPath.length === 0) {
        alert("No movement in this interval.");
        return;
    }

    // clear existing path
    pathLine.setLatLngs(filteredPath);
    dotMarker.setLatLng(filteredPath[filteredPath.length - 1]);
    map.fitBounds(filteredPath);
    closeHistory();
}


  function openHistoryPage() {
    window.location.href = "history.html"; 
  }


window.onload = function() {
  const savedHistory = localStorage.getItem("gpsHistory");
  const savedRecorded = localStorage.getItem("recordedData");

  if (savedHistory) {
    gpsHistory = JSON.parse(savedHistory);
    // Map pe purana path show karo
    pathCoords = gpsHistory.map(p => [p.lat, p.lon]);
    pathLine.setLatLngs(pathCoords);
    if (pathCoords.length > 0) {
      dotMarker.setLatLng(pathCoords[pathCoords.length - 1]);
      map.fitBounds(pathCoords);
    }
  }

  if (savedRecorded) {
    recordedData = JSON.parse(savedRecorded);
  }

     localStorage.removeItem("currentSession");

  gpsHistory = [];
  recordedData = [];
  pathCoords = [];
  pathLine.setLatLngs(pathCoords);
  dotMarker.setLatLng([0, 0]);
  map.setView([0, 0], 18);
};
</script>
</body>
</html>