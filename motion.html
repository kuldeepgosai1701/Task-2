<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  <title>GPS Motion Tracker with Leaflet</title>

Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

Â  <style>
Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  Â body, html {
Â  Â  Â height: 100%;
Â  Â  Â font-family: "Inter", sans-serif;
Â  Â  Â display: flex;
Â  Â  Â flex-direction: column;
Â  Â  Â background: #f7f9fc;
Â  Â  }

Â  Â  header {
Â  display: none;
}

.info {
Â  position: fixed;
Â  bottom: 20px;
Â  right: 20px;
Â  background: #fff;
Â  padding: 14px 16px;
Â  border-radius: 16px;
Â  z-index: 1001;
Â  width: 260px;
Â  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
Â  font-size: 25px;
Â  line-height: 1.4;
}
.info p:first-child {
Â  font-weight: 600;
Â  margin-bottom: 6px;
Â  font-size: 25px;
}


/* âœ… Buttons Group */
.button-group {
Â  margin-top: 10px;
Â  display: flex;
Â  gap: 10px;
}

.button-group button {
Â  flex: 1;
Â  padding: 8px;
Â  border: none;
Â  border-radius: 10px;
Â  font-weight: 600;
Â  cursor: pointer;
Â  color: white;
Â  transition: 0.2s;
Â  font-size: 18px;
}

.button-group .start {
Â  background: linear-gradient(135deg, #2a9df4, #00b300);
}
.button-group .stop {
Â  background: linear-gradient(135deg, #444, #b31515);
}
.button-group .reset {
Â  background: linear-gradient(135deg, #6c757d, #000000);
}
.button-group button:hover {
Â  opacity: 0.9;
}
Â 
.settings-btn {
Â  padding: 8px 14px;
Â  border: none;
Â  border-radius: 10px;
Â  font-weight: 600;
Â  cursor: pointer;
Â  color: white;
Â  font-size: 16px;
Â  background: linear-gradient(135deg, #2a9df4, #6c63ff); /* blue-purple gradient */
Â  transition: 0.2s;
}

.settings-btn:hover {
Â  opacity: 0.9;
Â  transform: scale(1.05);
}

Â  .sensitivity-box {
Â  position: fixed;
Â  top: 50%; Â  Â  Â  Â  Â  Â  Â  /* vertical center */
Â  left: 50%; Â  Â  Â  Â  Â  Â  Â /* horizontal center */
Â  transform: translate(-50%, -50%); /* exact middle */
Â  background: linear-gradient(135deg, #2a3b8f, #001f54);
Â  color: #fff;
Â  padding: 14px 18px;
Â  border-radius: 16px;
Â  z-index: 1001;
Â  width: 250px;
Â  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
Â  font-size: 14px;
Â  display: none; Â  Â  Â  Â  Â /* by default hidden */
}

.sensitivity-box.open {
Â  display: block; Â  Â  Â  Â  /* show box in center */
}


.sensitivity-box h3 {
Â  margin-bottom: 6px;
Â  font-size: 15px;
Â  font-weight: 600;
}

.sensitivity-box input[type="range"] {
Â  width: 100%;
Â  margin: 8px 0;
}

.history-btn {
Â  padding: 8px 14px;
Â  border: none;
Â  border-radius: 10px;
Â  font-weight: 600;
Â  cursor: pointer;
Â  color: white;
Â  font-size: 16px;
Â  background: linear-gradient(135deg, #ff7f50, #ff4500); /* orange gradient */
Â  transition: 0.2s;
Â  margin-left: 8px;
}

.history-btn:hover {
Â  opacity: 0.9;
Â  transform: scale(1.05);
}

Â  #map {
Â  flex: 1;
Â  width: 100%;
}
Â  </style>
</head>
<body>
<header>

<button onclick="openHistoryPage()" style="float: right; margin-right: 10px;">History</button>
</header>

<div class="sensitivity-box">
Â  <h3>Sensitivity</h3>
Â  <input type="range" id="sensitivityRange" min="0" max="10" step="1" value="5">
Â  Â  <div>Value: <span id="sensVal">5</span></div>
Â  Â  Â  <button id="saveSensitivity" style="margin-top:8px; padding:6px 10px; border:none;
Â  Â  Â  Â  Â  border-radius:8px; background:#28a745; color:#fff; font-weight:600; cursor:pointer;">
Â  Â  ğŸ’¾ Save
Â  </button>
</div>

<div class="info">
Â  <p>ğŸ“ Tracker Info
Â  Â <button class="settings-btn" onclick="toggleSettings()">âš™ Setting</button>
Â  Â <button class="history-btn" onclick="openHistoryPage()">ğŸ“œ History</button>
Â  </p>
Â  <p id="location">Location: Fetching...</p>
Â  <p id="direction">Direction: Calculating...</p>

Â  <div class="button-group">
Â  <button class="start" onclick="startTracking()">â–¶ Start</button>
Â  <button class="stop" Â onclick="stopTracking()">â¸ Stop</button>
Â  <button class="reset" onclick="resetPage()">âŸ³ Reset</button>
Â  <button id="saveBtn" style="flex: 1; padding: 8px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; color: white; background: linear-gradient(135deg, #28a745, #157347);">
Â ğŸ’¾ Save
Â </button>

Â </div> 
</div>

<div id="map"></div>

<div id="historyModal" 
Â  Â  Â style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
Â  Â  Â  Â  Â  Â  background:#fff; padding:20px; border-radius:12px; box-shadow:0px 4px 15px rgba(0,0,0,0.3);
Â  Â  Â  Â  Â  Â  z-index:2000; width:300px; max-height:400px; overflow:auto;">
Â  <h3>ğŸ“Œ History</h3>
Â  <ul id="historyList" style="list-style:none; padding-left:0;"></ul>
Â  <button onclick="closeHistory()" 
Â  Â  Â  Â  Â  style="margin-top:10px; background:#d9534f; color:#fff; border:none; padding:6px 12px; border-radius:6px;">Close</button>
</div>

<footer>
<p>Created by Kuldeep Gosai</p>
</footer>
</body>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// =================================================================
// 1. GLOBAL VARIABLES AND INITIALIZATION
// =================================================================

let isVibrating = false; // Tracks if device motion/vibration exceeds threshold
let initialMotionSetup = false; // Tracks if DeviceMotionEvent listener has been set up
let watchId = null; 
let prevLat = null, prevLon = null;
let gpsHistory = [];
let sessionStartTime = null;
let recordedData = [];
let sensitivityFactor = 5; // Default sensitivity
let trackingInterval = null;

// Variables for Google Sheet Save Button (currently unused/simplified)
let startPoint = null;
let stopPoint = null;
let startTime = null;
let stopTime = null;

const locationText = document.getElementById("location");
const directionText = document.getElementById("direction");
const sensitivityRange = document.getElementById("sensitivityRange");
const sensVal = document.getElementById("sensVal");
const saveSensitivityBtn = document.getElementById("saveSensitivity"); // Renamed for clarity

// =================================================================
// 2. LEAFLET MAP SETUP
// =================================================================

let map = L.map('map').setView([0, 0], 18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
Â  maxZoom: 19,
Â  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// The current location marker (defaults to blue)
let dotMarker = L.circleMarker([0, 0], {
Â  radius: 10,
Â  fillColor: "#007bff", // Default Blue
Â  color: "#003366",
Â  weight: 2,
Â  opacity: 1,
Â  fillOpacity: 0.9
}).addTo(map);

let pathCoords = [];
let pathLine = L.polyline(pathCoords, { color: 'blue' }).addTo(map);

// =================================================================
// 3. CORE GPS AND MOTION TRACKING LOGIC
// =================================================================

/**
 * Handles device motion data to check for "vibration" or significant movement.
 */
function handleDeviceMotion(event) {
Â  Â  if (!event.accelerationIncludingGravity) return; 

Â  Â  const acc = event.accelerationIncludingGravity;
Â  Â  
Â  Â  // Calculate the total magnitude of movement (Pythagorean theorem in 3D)
Â  Â  // This measures the total force/shake on the device.
Â  Â  const motionMagnitude = Math.sqrt(
Â  Â  Â  Â  acc.x * acc.x + 
Â  Â  Â  Â  acc.y * acc.y + 
Â  Â  Â  Â  acc.z * acc.z
Â  Â  );

Â  Â  // Dynamic Threshold: Sensitivity 1 (most sensitive) -> threshold 1.0, Sensitivity 10 (least sensitive) -> threshold 10.0
Â  Â  // The sensitivity factor is used to set the tolerance for movement.
Â  Â  const threshold = (sensitivityFactor * 0.9) + 1.0; 

Â  Â  if (motionMagnitude > threshold) {
Â  Â  Â  Â  isVibrating = true;
Â  Â  } else {
Â  Â  Â  Â  isVibrating = false;
Â  Â  }
}

/**
 * Requests device motion permission (required by iOS 13+) and starts the listener.
 */
function startMotionListener() {
    if (initialMotionSetup) return;

Â  Â  if (typeof DeviceMotionEvent.requestPermission === 'function') {
Â  Â  Â  Â  DeviceMotionEvent.requestPermission()
Â  Â  Â  Â  Â  Â  .then(permissionState => {
Â  Â  Â  Â  Â  Â  Â  Â  if (permissionState === 'granted') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.addEventListener('devicemotion', handleDeviceMotion);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initialMotionSetup = true;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Device Motion permission denied.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(console.error);
Â  Â  } else {
Â  Â  Â  Â  window.addEventListener('devicemotion', handleDeviceMotion);
Â  Â  Â  Â  initialMotionSetup = true;
Â  Â  }
}


/**
 * Callback function for continuous GPS updates.
 */
function showLocation(position) {
Â  Â  const lat = position.coords.latitude;
Â  Â  const lon = position.coords.longitude;
Â  Â  const timestamp = new Date(); Â 
Â  Â  
Â  Â // VIBRATION/COLOR LOGIC: Change marker color based on motion state
Â  Â  const dotColor = isVibrating ? "#dc3545" : "#007bff"; // Red for vibration, Blue otherwise
Â  Â  
Â  Â  dotMarker.setStyle({ fillColor: dotColor, color: dotColor });
Â  Â  
Â  Â  // Store GPS and vibration data
Â  Â  gpsHistory.push({lat, lon, time: timestamp, isVibration: isVibrating});
Â  Â  localStorage.setItem("gpsHistory", JSON.stringify(gpsHistory));

Â  Â  // UI update and Map manipulation
Â  Â  locationText.textContent = `Location: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
Â  Â  pathCoords.push([lat, lon]);
Â  Â  pathLine.setLatLngs(pathCoords);
Â  Â  dotMarker.setLatLng([lat, lon]);
Â  Â  map.setView([lat, lon]);

Â  Â  // Calculate direction
Â  Â  if (prevLat !== null && prevLon !== null) {
Â  Â  Â  const dx = lon - prevLon;
Â  Â  Â  const dy = lat - prevLat;
Â  Â  Â  const angle = Math.atan2(dy, dx) * (180 / Math.PI);
Â  Â  Â  directionText.textContent = `Direction: ${getDirectionFromAngle(angle)}`;
Â  Â  }

Â  Â  prevLat = lat;
Â  Â  prevLon = lon;
}

/**
 * Starts continuous GPS and Motion tracking.
 */
function startTracking() {
Â  Â  if ("geolocation" in navigator) {
        startMotionListener(); // Start listening for device motion

Â  Â  Â  Â  // Check if sessions already exist and start a new one
Â  Â  Â  Â  let sessions = JSON.parse(localStorage.getItem("sessions")) || [];
Â  Â  Â  Â  sessionStartTime = new Date();
Â  Â  Â  Â  gpsHistory = []; // reset for new session
Â  Â  Â  Â  localStorage.setItem("currentSession", JSON.stringify(gpsHistory));

Â  Â  Â  Â  sessions.push({
Â  Â  Â  Â  Â  start: sessionStartTime.toISOString(),
Â  Â  Â  Â  Â  end: null,
Â  Â  Â  Â  Â  data: []
Â  Â  Â  Â  });
Â  Â  Â  Â  localStorage.setItem("sessions", JSON.stringify(sessions));

Â  Â  Â  Â  // Start continuous GPS tracking
Â  Â  Â  Â  watchId = navigator.geolocation.watchPosition(showLocation, showError, {
Â  Â  Â  Â  Â  enableHighAccuracy: true,
Â  Â  Â  Â  Â  maximumAge: 0,
Â  Â  Â  Â  Â  timeout: 5000
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  alert("GPS not supported on this device/browser.");
Â  Â  }
}

/**
 * Stops GPS tracking and finalizes the current session data.
 */
function stopTracking() {
Â  Â  if (watchId !== null) {
Â  Â  Â  Â  navigator.geolocation.clearWatch(watchId);
Â  Â  Â  Â  watchId = null;

Â  Â  Â  Â  // Finalize session data
Â  Â  Â  Â  let sessions = JSON.parse(localStorage.getItem("sessions")) || [];
Â  Â  Â  Â  let current = sessions[sessions.length - 1];
Â  Â  Â  Â  if (current && !current.end) {
Â  Â  Â  Â  Â  current.end = new Date().toISOString();
Â  Â  Â  Â  Â  current.data = [...gpsHistory]; 
Â  Â  Â  Â  Â  localStorage.setItem("sessions", JSON.stringify(sessions));
Â  Â  Â  Â  }
Â  Â  }
}


// =================================================================
// 4. UTILITY AND UI FUNCTIONS
// =================================================================

function showError(error) {
Â  console.error("GPS Error:", error);
Â  switch(error.code) {
Â  Â  case error.PERMISSION_DENIED:
Â  Â  Â  locationText.textContent = "Location: Permission denied";
Â  Â  Â  break;
Â  Â  case error.POSITION_UNAVAILABLE:
Â  Â  Â  locationText.textContent = "Location: Position unavailable";
Â  Â  Â  break;
Â  Â  case error.TIMEOUT:
Â  Â  Â  locationText.textContent = "Location: Timeout";
Â  Â  Â  break;
Â  Â  default:
Â  Â  Â  locationText.textContent = "Location: Unknown error";
Â  Â  Â  break;
Â  }
}

function getDirectionFromAngle(angle) {
Â  // Normalize angle (0â€“360 degrees)
Â  angle = (angle + 360) % 360;

Â  if (angle >= 337.5 || angle < 22.5) return "East â†’";
Â  if (angle >= 22.5 && angle < 67.5) return "North-East â†—ï¸";
Â  if (angle >= 67.5 && angle < 112.5) return "North â†‘";
Â  if (angle >= 112.5 && angle < 157.5) return "North-West â†–ï¸";
Â  if (angle >= 157.5 && angle < 202.5) return "West â†";
Â  if (angle >= 202.5 && angle < 247.5) return "South-West â†™ï¸";
Â  if (angle >= 247.5 && angle < 292.5) return "South â†“";
Â  if (angle >= 292.5 && angle < 337.5) return "South-East â†˜ï¸";
Â  
Â  return "Unknown";
}

function resetPage() {
Â  pathCoords = [];
Â  pathLine.setLatLngs(pathCoords);

Â  if (prevLat && prevLon) {
Â  Â  dotMarker.setLatLng([prevLat, prevLon]);
Â  Â  map.panTo([prevLat, prevLon], {animate: true, duration: 0.5});
Â  }
}


function toggleSettings() {
Â  const box = document.querySelector(".sensitivity-box");
Â  box.classList.toggle("open");
}

function openHistoryPage() {
Â  Â  // Original code tries to open a separate page, keeping it as is.
Â  Â  window.location.href = "history.html"; 
}


// Sensitivity Slider Listeners
let tempSensitivity = sensitivityFactor; 
sensitivityRange.addEventListener("input", () => {
Â  tempSensitivity = parseFloat(sensitivityRange.value);
Â  sensVal.textContent = sensitivityRange.value;
});

saveSensitivityBtn.addEventListener("click", () => {
Â  sensitivityFactor = tempSensitivity;
Â  alert("âœ… Sensitivity saved: " + sensitivityFactor);
Â  toggleSettings(); // Close box after saving
});


// Close sensitivity box if clicked outside
document.addEventListener("click", function(event) {
Â  const box = document.querySelector(".sensitivity-box");
Â  const settingsBtn = document.querySelector(".settings-btn");

Â  if (box.classList.contains("open") && !box.contains(event.target) && !settingsBtn.contains(event.target)) {
Â  Â  box.classList.remove("open");
Â  }
});

// Original History Modal (simplified for display)
function toggleHistory() {
Â  Â  alert("History functionality not fully implemented on this page. Check history.html.");
}
function closeHistory() {
Â  Â  document.getElementById("historyModal").style.display = "none";
}

// Google Sheet Save Button - Note: The scriptURL will need to be valid for this to work.
document.getElementById("saveBtn").addEventListener("click", () => {
Â  alert("Save to Google Sheet functionality initiated.");
Â  // Actual fetch logic removed for safety and simplification, as it requires a valid URL setup.
});


// Final window.onload: Clear local storage (as per original code) and initialize map view.
window.onload = function() {
Â  Â  // Clear old data on load, as per the original intention
Â  Â  localStorage.removeItem("gpsHistory");
Â  Â  localStorage.removeItem("recordedData");
Â  Â  localStorage.removeItem("sessions");
Â  Â  localStorage.removeItem("currentSession");

Â  Â  gpsHistory = [];
Â  Â  recordedData = [];
Â  Â  pathCoords = [];
Â  Â  pathLine.setLatLngs(pathCoords);
Â  Â  dotMarker.setLatLng([0, 0]);
Â  Â  map.setView([0, 0], 18);
};
</script>
</body>

</html>