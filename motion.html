<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPS Motion Tracker with Leaflet</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html {
     height: 100%;
     display: flex;
     flex-direction: column; }

    header {
      background: #004080;
      color: #fff;
      text-align: center;
      padding: 15px;
      font-size: 1.6rem;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .sensitivity-box {
      position: fixed;
      top: 70px;
      right: 20px;
      background: rgba(0, 64, 128, 0.9);
      color: #fff;
      padding: 12px 16px;
      border-radius: 12px;
      z-index: 1001;
    }

    .sensitivity-box input[type="range"] {
      width: 150px;
    }

    .info {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 12px;
      z-index: 1001;
      width: 250px;
    }

    button {
      margin-top: 5px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      background: linear-gradient(120deg, #007bff, #0056b3);
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: linear-gradient(120deg, #0056b3, #003f8c);
    }

    #map {
     flex: 1;
     width: 100%;
     position: relative; /* remove absolute positioning */
    }

    footer {
      background: linear-gradient(90deg, #004080, #0066cc);
       color: white;
  text-align: center;
  padding: 14px;
  font-size: 1rem;
    }
  </style>
</head>

<body>
<header>
 </h1> Motion Tracker</h1>
<button onclick="openHistoryPage()" style="float: right; margin-right: 10px;">History</button>
</header>

<div class="sensitivity-box">
  <h3>Sensitivity</h3>
  <input type="range" id="sensitivityRange" min="0" max="10" step="1" value="5">
  <div>Value: <span id="sensVal">5</span></div>
</div>

<div class="info">
  <p>üìç Tracker Info</p>
  <p id="location">Location: Fetching...</p>
  <p id="direction">Direction: Calculating...</p>
  <button onclick="startTracking()">Start</button>
  <button onclick="stopTracking()">Stop</button>
  <button onclick="resetPage()">Reset</button>
  <button onclick="saveDataToFile()">Save</button>
</div>

<!-- Map container -->
<div id="map"></div>

<!-- History Modal -->
<div id="historyModal" 
     style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            background:#fff; padding:20px; border-radius:12px; box-shadow:0px 4px 15px rgba(0,0,0,0.3);
            z-index:2000; width:300px; max-height:400px; overflow:auto;">
  <h3>üìå History</h3>
  <ul id="historyList" style="list-style:none; padding-left:0;"></ul>
  <button onclick="closeHistory()" 
          style="margin-top:10px; background:#d9534f; color:#fff; border:none; padding:6px 12px; border-radius:6px;">Close</button>
</div>

<footer>
<p>Created by Kuldeep Gosai</p>
</footer>
</body>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  let prevLat = null, prevLon = null;
  let gpsHistory = [];
  let recordedData = [];
  let sensitivityFactor = 5;
  let vibratedRecently = false;
  let trackingInterval = null;

  const locationText = document.getElementById("location");
  const directionText = document.getElementById("direction");
  const sensitivityRange = document.getElementById("sensitivityRange");
  const sensVal = document.getElementById("sensVal");

  sensitivityRange.addEventListener("input", () => {
    sensitivityFactor = parseFloat(sensitivityRange.value);
    sensVal.textContent = sensitivityRange.value;
  });

  // Leaflet map setup
  let map = L.map('map').setView([0, 0], 18);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let dotMarker = L.circleMarker([0, 0], {
    radius: 10,
    fillColor: "#007bff",
    color: "#003366",
    weight: 2,
    opacity: 1,
    fillOpacity: 0.9
  }).addTo(map);

  let pathCoords = [];
  let pathLine = L.polyline(pathCoords, { color: 'blue' }).addTo(map);

function showLocation(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const timestamp = new Date();  // current time

    // GPS history me store karo
    gpsHistory.push({lat, lon, time: timestamp});

   // ‚úÖ localStorage me bhi save karo
    localStorage.setItem("gpsHistory", JSON.stringify(gpsHistory));

   // existing code
    locationText.textContent = `Location: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    pathCoords.push([lat, lon]);
    pathLine.setLatLngs(pathCoords);
    dotMarker.setLatLng([lat, lon]);
    map.setView([lat, lon]);

    if (prevLat !== null && prevLon !== null) {
      const dx = lon - prevLon;
      const dy = lat - prevLat;
      const angle = Math.atan2(dy, dx) * (180 / Math.PI);
      directionText.textContent = `Direction: ${getDirectionFromAngle(angle)}`;
    }

    prevLat = lat;
    prevLon = lon;
}


  function getDirectionFromAngle(angle) {
    const directions = ["East ‚Üí", "North-East ‚ÜóÔ∏è", "North ‚Üë", "North-West ‚ÜñÔ∏è",
                        "West ‚Üê", "South-West ‚ÜôÔ∏è", "South ‚Üì", "South-East ‚ÜòÔ∏è"];
    return directions[Math.round((angle % 360 + 360) % 360 / 45) % 8];
  }

 function showError(error) {
  console.error("GPS Error:", error);
  switch(error.code) {
    case error.PERMISSION_DENIED:
      locationText.textContent = "Location: Permission denied";
      break;
    case error.POSITION_UNAVAILABLE:
      locationText.textContent = "Location: Position unavailable";
      break;
    case error.TIMEOUT:
      locationText.textContent = "Location: Timeout";
      break;
    default:
      locationText.textContent = "Location: Unknown error";
      break;
  }
}


function saveDataToFile() {
  // sensitivity box ka value hi number of entries decide karega
  const numberOfEntries = parseInt(sensitivityRange.value);

  // last N entries select karo
  const recentData = recordedData.slice(-numberOfEntries);

  if (recentData.length === 0) {
    alert("No data to save.");
    return;
  }

  // text file content banao
  let fileContent = "X\tY\tZ\tVibration\tDirection\n";
  recentData.forEach(entry => {
    fileContent += `${entry.x.toFixed(2)}\t${entry.y.toFixed(2)}\t${entry.z.toFixed(2)}\t${entry.vibration}\t${entry.direction}\n`;
  });

  // download trigger karo
  const blob = new Blob([fileContent], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `motion_data_last_${numberOfEntries}.txt`; // filename me bhi show karega
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

 function startTracking() {
  if ("geolocation" in navigator) {
    // ‚úÖ continuous GPS tracking
    trackingInterval = navigator.geolocation.watchPosition(
      showLocation,
      showError,
      {
        enableHighAccuracy: true,   // GPS chip use karega
        timeout: 10000,             // max wait 10 sec
        maximumAge: 0               // purana cache use na kare
      }
    );
  } else {
    alert("Geolocation not supported in this browser.");
  }
}

function stopTracking() {
  if (trackingInterval) {
    navigator.geolocation.clearWatch(trackingInterval);
    trackingInterval = null;
  }
}

 function resetPage() {
  // Path clear karo (screen se)
  pathCoords = [];
  pathLine.setLatLngs(pathCoords);

  // Dot ko center me set karo
  dotMarker.setLatLng([0,0]);
  map.setView([0,0], 18);

  // ‚ùå NOTE: gpsHistory ko clear NAHI karna 
  // Matlab purana data localStorage me safe hai
}


function toggleHistory() {
    const modal = document.getElementById("historyModal");
    const list = document.getElementById("historyList");
    list.innerHTML = "";

    if (modal.style.display === "none") {
        if (gpsHistory.length === 0) {
            alert("No history available yet.");
            return;
        }

        // 1 minute ya 5 minute interval ke basis pe group kar sakte ho
        // yaha simple approach: poora session ko 1 entry ke liye consider kar rahe hain
        const startTime = gpsHistory[0].time;
        const endTime = gpsHistory[gpsHistory.length - 1].time;

        const li = document.createElement("li");
        li.style.cursor = "pointer";
        li.textContent = `${startTime.toLocaleDateString()} ${startTime.toLocaleTimeString()} ‚Äì ${endTime.toLocaleTimeString()}`;
        li.onclick = () => showHistoryPath(startTime, endTime);
        list.appendChild(li);

        modal.style.display = "block";
    } else {
        modal.style.display = "none";
    }
}

function closeHistory() {
    document.getElementById("historyModal").style.display = "none";
}

function showHistoryPath(startTime, endTime) {
    // filter gpsHistory for selected time range
    const filteredPath = gpsHistory.filter(p => p.time >= startTime && p.time <= endTime)
                                   .map(p => [p.lat, p.lon]);

    if (filteredPath.length === 0) {
        alert("No movement in this interval.");
        return;
    }

    // clear existing path
    pathLine.setLatLngs(filteredPath);
    dotMarker.setLatLng(filteredPath[filteredPath.length - 1]);
    map.fitBounds(filteredPath);
    closeHistory();
}


  function openHistoryPage() {
    window.location.href = "history.html"; // ‡§®‡§Ø‡§æ ‡§™‡•á‡§ú ‡§ñ‡•Å‡§≤‡•á‡§ó‡§æ
  }


window.onload = function() {
  const savedHistory = localStorage.getItem("gpsHistory");
  const savedRecorded = localStorage.getItem("recordedData");

  if (savedHistory) {
    gpsHistory = JSON.parse(savedHistory);
    // Map pe purana path show karo
    pathCoords = gpsHistory.map(p => [p.lat, p.lon]);
    pathLine.setLatLngs(pathCoords);
    if (pathCoords.length > 0) {
      dotMarker.setLatLng(pathCoords[pathCoords.length - 1]);
      map.fitBounds(pathCoords);
    }
  }

  if (savedRecorded) {
    recordedData = JSON.parse(savedRecorded);
  }
};
</script>
</body>
</html>














